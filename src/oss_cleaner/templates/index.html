<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSS 冗余图片清理</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body { 
            background: var(--bg);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: var(--text);
            padding-bottom: 40px;
            margin: 0;
        }

        /* Navbar */
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .navbar-brand { font-weight: 800; color: var(--primary) !important; display: flex; align-items: center; gap: 8px; }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 24px;
            padding: 24px 0;
        }

        /* Card & Animation */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.1); }
        .card.selected { border: 2px solid var(--primary); background: #f5f7ff; }
        
        /* 删除动画 */
        .card.deleting { transform: scale(0.1); opacity: 0; pointer-events: none; }

        /* 图片容器：核心修复区域 */
        .img-area {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #f1f5f9;
            overflow: hidden;
            cursor: pointer;
        }

        /* 1. 占位层：层级最高 (z-index: 10) */
        .img-area .placeholder {
            position: absolute;
            inset: 0;
            z-index: 10; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--text-muted);
            background: #f1f5f9; /* 必须有背景色，防止透视到下方的碎图 */
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        /* 2. 图片层：层级较低 (z-index: 5) */
        .img-area img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 5;
            opacity: 0; /* 默认不可见，但占据 DOM 空间 */
            transition: opacity 0.4s ease;
        }

        /* 当图片加载完成后的状态 */
        .img-area img.loaded {
            opacity: 1;
        }
        
        /* 预览大图的 Dialog */
        #viewer {
            border: none;
            background: transparent;
            width: 100vw; height: 100vh;
            max-width: 100vw; max-height: 100vh;
            padding: 0; margin: 0;
            overflow: hidden;
        }
        #viewer::backdrop { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px); }
        .viewer-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
        
        /* 大图残留修复：默认通过 opacity 隐藏而非 display:none */
        #viewImg {
            max-width: 90%; max-height: 90%;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            opacity: 0; 
            transition: opacity 0.3s;
        }
        #viewImg.show { opacity: 1; }

        .close-btn {
            position: absolute; top: 24px; right: 24px;
            background: rgba(255,255,255,0.2); color: white;
            border: none; border-radius: 50%; width: 44px; height: 44px;
            cursor: pointer; z-index: 100; font-size: 1.5rem;
        }

        /* 信息区 */
        .card-info { padding: 12px 16px; border-top: 1px solid var(--border); }
        .card-info .name { font-size: 0.85rem; font-weight: 600; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .empty { text-align: center; padding: 100px 20px; display: none; }
        .empty.show { display: block; }
    </style>
</head>
<body>
    <nav class="navbar sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-check"></i> OSS Cleaner
            </a>
            
            <div class="d-flex align-items-center gap-3">
                <span class="text-muted d-none d-lg-inline small">
                    孤儿图片：<span id="orphanCount" class="text-danger fw-bold">{{ count }}</span>
                </span>
                <button class="btn btn-sm btn-light border" onclick="config.showModal()"><i class="bi bi-gear"></i></button>
                <div class="form-check mb-0">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                    <label class="form-check-label small" for="selectAll">全选</label>
                </div>
                <button class="btn btn-sm btn-danger px-3" id="deleteBtn"><i class="bi bi-trash3"></i> 删除</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <dialog id="config" class="border-0 shadow-lg rounded-4" style="width: 90%; max-width: 600px;">
            <div class="p-4">
                <h5 class="mb-4 fw-bold">系统配置</h5>
                <form id="configForm" class="row g-3">
                    <div class="col-md-6"><label class="form-label small fw-bold">AK ID</label><input type="text" class="form-control form-control-sm" name="ACCESS_KEY_ID"></div>
                    <div class="col-md-6"><label class="form-label small fw-bold">AK Secret</label><input type="password" class="form-control form-control-sm" name="ACCESS_KEY_SECRET"></div>
                    <div class="col-12"><label class="form-label small fw-bold">Endpoint</label><input type="text" class="form-control form-control-sm" name="ENDPOINT"></div>
                    <div class="col-md-6"><label class="form-label small fw-bold">Bucket</label><input type="text" class="form-control form-control-sm" name="BUCKET_NAME"></div>
                    <div class="col-md-6"><label class="form-label small fw-bold">Domain</label><input type="text" class="form-control form-control-sm" name="OSS_DOMAIN"></div>
                    <div class="col-12"><label class="form-label small fw-bold">Markdown Path</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" name="MARKDOWN_PATH" id="markdownPath">
                            <button type="button" class="btn btn-outline-secondary" id="folderBtn"><i class="bi bi-folder"></i></button>
                        </div>
                    </div>
                    <div class="col-12"><label class="form-label small fw-bold">Prefix</label><input type="text" class="form-control form-control-sm" name="PREFIX"></div>
                </form>
                <div class="mt-4 d-flex justify-content-end gap-2">
                    <button class="btn btn-sm btn-light" onclick="config.close()">取消</button>
                    <button class="btn btn-sm btn-primary" id="saveBtn">保存并刷新</button>
                </div>
            </div>
        </dialog>

        <dialog id="viewer">
            <div class="viewer-content" onclick="closePreview()">
                <button class="close-btn">&times;</button>
                <img id="viewImg" src="">
            </div>
        </dialog>

        <div class="grid" id="imageGrid">
            {% for file in orphans %}
            <div class="card" data-key="{{ file.key }}">
                <div class="img-area" onclick="handleImgClick(this)" data-url="{{ file.url }}">
                    <div class="placeholder">
                        <i class="bi bi-eye fs-4"></i>
                        <span>预览图片</span>
                    </div>
                    <img src="" alt="preview">
                </div>
                
                <div class="card-info">
                    <span class="name" title="{{ file.name }}">{{ file.name }}</span>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="{{ file.key }}" onchange="syncCardState(this)">
                            <label class="small text-muted">选择</label>
                        </div>
                        <span class="badge bg-light text-dark border">{{ file.size }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div id="emptyState" class="empty {% if count == 0 and not error %}show{% endif %}">
            <i class="bi bi-check2-circle text-success" style="font-size: 4rem;"></i>
            <h4 class="mt-3">太棒了，没有多余图片</h4>
        </div>
    </div>

    <script>
        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);

        // --- 图片加载逻辑：修复层级与残留 ---
        function handleImgClick(area) {
            const img = area.querySelector('img');
            const url = area.dataset.url;
            const placeholder = area.querySelector('.placeholder');

            // 如果已经加载成功了，直接看大图
            if (img.classList.contains('loaded')) {
                showPreview(url);
                return;
            }

            // 更新占位符为加载状态，由于 z-index:10，它一定在最上面
            placeholder.innerHTML = `
                <div class="spinner-border spinner-border-sm text-primary"></div>
                <span class="mt-1">正在加载...</span>
            `;

            // 开始加载：设置 src 触发浏览器下载
            // 我们不用 new Image() 而是直接用 DOM 里的 img 标签，保证一致性
            img.onload = () => {
                img.classList.add('loaded'); // CSS 会让 opacity 变为 1
                placeholder.style.opacity = '0'; // 占位符淡出
                setTimeout(() => {
                    placeholder.style.visibility = 'hidden'; // 彻底不挡点击
                    showPreview(url);
                }, 300);
            };

            img.onerror = () => {
                placeholder.innerHTML = `
                    <i class="bi bi-exclamation-triangle text-danger"></i>
                    <span class="text-danger small">无法加载</span>
                `;
            };

            img.src = url;
        }

        function showPreview(url) {
            const vImg = $('#viewImg');
            vImg.src = url;
            vImg.onload = () => vImg.classList.add('show');
            $('#viewer').showModal();
        }

        function closePreview() {
            const viewer = $('#viewer');
            const vImg = $('#viewImg');
            vImg.classList.remove('show');
            viewer.close();
            // 延迟清空 src 彻底解决残留闪烁
            setTimeout(() => { vImg.src = ""; }, 300);
        }

        // --- 批量删除逻辑：视觉平滑移除 ---
        $('#deleteBtn').onclick = async () => {
            const selectedCbs = [...$$('.grid .form-check-input:checked')];
            const keys = selectedCbs.map(cb => cb.value);

            if (!keys.length) return alert('请先选择图片');
            if (!confirm(`确认永久删除这 ${keys.length} 张图片吗？`)) return;

            $('#deleteBtn').disabled = true;
            $('#deleteBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span> 执行中...';

            try {
                const res = await fetch('/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keys })
                });

                const result = await res.json();
                if (result.status === 'success') {
                    // 执行缩小消失动画
                    selectedCbs.forEach(cb => {
                        const card = cb.closest('.card');
                        card.classList.add('deleting');
                    });

                    // 动画结束后从 DOM 彻底移除
                    setTimeout(() => {
                        selectedCbs.forEach(cb => cb.closest('.card').remove());
                        const remaining = $$('.card').length;
                        $('#orphanCount').textContent = remaining;
                        if (remaining === 0) $('#emptyState').classList.add('show');
                    }, 400);
                } else {
                    alert('删除失败: ' + result.message);
                }
            } catch (e) {
                alert('网络请求异常');
            } finally {
                $('#deleteBtn').disabled = false;
                $('#deleteBtn').innerHTML = '<i class="bi bi-trash3"></i> 删除';
            }
        };

        // --- 基础交互 ---
        function syncCardState(cb) {
            cb.closest('.card').classList.toggle('selected', cb.checked);
        }

        $('#selectAll').onchange = (e) => {
            $$('.grid .form-check-input').forEach(cb => {
                cb.checked = e.target.checked;
                syncCardState(cb);
            });
        };

        $('#saveBtn').onclick = async () => {
            const data = Object.fromEntries(new FormData($('#configForm')));
            await fetch('/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            location.reload();
        };

        $('#folderBtn').onclick = async () => {
            const res = await fetch('/select-folder').then(r => r.json());
            if (res.status === 'success') $('#markdownPath').value = res.path;
        };

        // 初始化加载配置
        window.onload = async () => {
            const res = await fetch('/config').then(r => r.json()).catch(() => ({}));
            Object.entries(res).forEach(([k, v]) => {
                if($('#configForm').elements[k]) $('#configForm').elements[k].value = v || '';
            });
            {% if error %} $('#config').showModal(); {% endif %}
        };
    </script>
</body>
</html>