<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSS 冗余图片清理</title>
    <link
      href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --primary: #4f46e5;
        --primary-hover: #4338ca;
        --bg: #f3f4f6;
        --card: #ffffff;
        --text: #111827;
        --text-muted: #6b7280;
        --border: rgba(0, 0, 0, 0.05);
      }

      * {
        box-sizing: border-box;
      }

      body {
        background: var(--bg);
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        padding-bottom: 40px;
        margin: 0;
      }

      button:focus,
      .btn:focus,
      .btn-close:focus {
        outline: none !important;
        box-shadow: none !important;
      }

      /* Navbar */
      .navbar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .navbar-brand {
        font-weight: 700;
        color: var(--primary) !important;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Grid */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        padding: 24px 0;
      }

      /* Card */
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }

      .card.selected {
        border: 2px solid var(--primary);
        background: #eef2ff;
      }

      /* 修改图片区域，确保占位符在最前面 */
      .img-area {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        background: #e5e7eb; /* 稍微深一点的灰色，方便看清图标 */
        overflow: hidden;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .img-area .placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
        z-index: 2; /* 确保在图片上方 */
        pointer-events: none;
        transition: opacity 0.2s;
      }

      .img-area img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        z-index: 1;
        transition: opacity 0.3s ease;
      }

      .img-area img.loaded {
        opacity: 1;
      }

      .card:hover .img-area img.loaded {
        transform: scale(1.05);
      }

      .img-area .placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
        pointer-events: none;
      }

      .img-area .placeholder.hide {
        display: none;
      }

      /* Card Info */
      .card-info {
        padding: 12px 16px;
        border-top: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .card-info .name {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .card-info .meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      /* Checkbox */
      .form-check-input {
        cursor: pointer;
        width: 1.2em;
        height: 1.2em;
      }

      .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
      }

      /* Buttons */
      .btn-primary {
        background: var(--primary);
        border-color: var(--primary);
      }

      .btn-primary:hover {
        background: var(--primary-hover);
        border-color: var(--primary-hover);
      }

      /* Empty State */
      .empty {
        text-align: center;
        padding: 80px 20px;
        color: var(--text-muted);
      }

      .empty i {
        font-size: 4rem;
        color: #d1d5db;
        display: block;
        margin-bottom: 20px;
      }

      /* Dialog */
      dialog {
        border: none;
        border-radius: 12px;
        padding: 0;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
      }

      dialog[open] {
        animation: slideIn 0.2s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Image Viewer */
      #viewer {
        width: 100vw;
        height: 100vh;
        max-width: 100vw;
        max-height: 100vh;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin: 0;
      }

      #viewer::backdrop {
        background: rgba(0, 0, 0, 0.9);
      }

      #viewer img {
        max-width: 90vw;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 4px;
        cursor: zoom-out;
      }

      .close-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.1);
      }

      .close-btn:active {
        transform: scale(0.95);
      }

      .close-btn svg {
        width: 24px;
        height: 24px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar sticky-top">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="bi bi-images"></i> OSS Cleaner
        </a>

        <div class="d-flex align-items-center gap-3">
          <span class="text-muted d-none d-md-inline">
            发现 <span class="text-danger fw-bold">{{ count }}</span> 张孤儿图片
          </span>

          <div class="vr d-none d-md-block"></div>

          <button class="btn btn-light border" onclick="openConfig()">
            <i class="bi bi-gear-fill"></i>
            <span class="d-none d-sm-inline">设置</span>
          </button>

          <div class="d-flex align-items-center gap-2">
            <input class="form-check-input" type="checkbox" id="selectAll" />
            <label class="form-check-label user-select-none" for="selectAll"
              >全选</label
            >
          </div>

          <button class="btn btn-danger" id="deleteBtn">
            <i class="bi bi-trash"></i> 删除选中
          </button>
        </div>
      </div>
    </nav>

    {% if error %}
    <div class="container mt-4">
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <div class="d-flex align-items-center">
          <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
          <div>
            <h5 class="alert-heading fw-bold mb-1">需要配置</h5>
            <p class="mb-0">{{ error }}</p>
          </div>
        </div>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
    </div>
    {% endif %}

    <div class="container">
      <dialog id="config" style="width: 90%; max-width: 800px">
        <div class="modal-content border-0">
          <div class="modal-header border-bottom-0 pb-0 p-4">
            <h5 class="modal-title fw-bold">系统配置</h5>
            <button
              type="button"
              class="btn-close"
              onclick="config.close()"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="form" class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Access Key ID</label>
                <input
                  type="text"
                  class="form-control"
                  name="ACCESS_KEY_ID"
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Access Key Secret</label>
                <input
                  type="password"
                  class="form-control"
                  name="ACCESS_KEY_SECRET"
                  required
                />
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Endpoint</label>
                <input
                  type="text"
                  class="form-control"
                  name="ENDPOINT"
                  placeholder="oss-cn-beijing.aliyuncs.com"
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Bucket Name</label>
                <input
                  type="text"
                  class="form-control"
                  name="BUCKET_NAME"
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">OSS Domain</label>
                <input
                  type="text"
                  class="form-control"
                  name="OSS_DOMAIN"
                  placeholder="oss.example.com"
                  required
                />
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Markdown Path</label>
                <div class="input-group">
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="folderBtn"
                  >
                    <i class="bi bi-folder2-open"></i>
                  </button>
                  <input
                    type="text"
                    class="form-control"
                    name="MARKDOWN_PATH"
                    required
                  />
                </div>
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Prefix</label>
                <input
                  type="text"
                  class="form-control"
                  name="PREFIX"
                  placeholder="images/"
                  required
                />
              </div>
            </form>
          </div>
          <div
            class="modal-footer border-top-0 p-4 d-flex justify-content-between"
          >
            <button type="button" class="btn btn-info text-white" id="testBtn">
              <i class="bi bi-lightning-charge-fill"></i> 测试连接
            </button>
            <div>
              <button
                type="button"
                class="btn btn-light me-2"
                onclick="config.close()"
              >
                取消
              </button>
              <button type="button" class="btn btn-primary px-4" id="saveBtn">
                保存
              </button>
            </div>
          </div>
        </div>
      </dialog>

      <dialog id="viewer">
        <button class="close-btn" onclick="viewer.close()">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
          >
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
        <img id="viewImg" />
      </dialog>

      <div class="grid">
        {% for file in orphans %}
        <div class="card" data-id="{{ loop.index }}">
          <div
            class="img-area"
            onclick="loadImg(this)"
            data-url="{{ file.url }}"
          >
            <div class="placeholder">
              <i class="bi bi-eye fs-4"></i>
              <span>点击预览</span>
            </div>
            <img />
          </div>

          <div class="card-info">
            <div class="d-flex align-items-center gap-2">
              <input
                class="form-check-input"
                type="checkbox"
                value="{{ file.key }}"
                onchange="toggleCard(this)"
              />
              <span class="name" title="{{ file.name }}">{{ file.name }}</span>
            </div>
            <div class="meta">
              <span class="badge bg-light text-secondary">{{ file.size }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if count == 0 and not error %}
      <div class="empty">
        <i class="bi bi-check-circle-fill text-success"></i>
        <h3 class="fw-bold">太棒了！</h3>
        <p class="lead">没有发现冗余图片</p>
      </div>
      {% endif %}
    </div>

    <footer class="text-center text-muted py-4 mt-5 border-top">
      <small>OSS Cleaner v{{ version }}</small>
    </footer>

    <script>
            {% if error %}
            addEventListener('DOMContentLoaded', () => openConfig());
            {% endif %}

            const $$ = s => document.querySelectorAll(s);
            const $ = s => document.querySelector(s);

            // Toggle card selection
            function toggleCard(cb) {
                cb.closest('.card').classList.toggle('selected', cb.checked);
            }

            // Config
            async function openConfig() {
                const res = await fetch('/config').catch(() => null);
                if (res?.ok) {
                    const data = await res.json();
                    Object.entries(data).forEach(([k, v]) => {
                        const input = form.elements[k];
                        if (input) input.value = v || '';
                    });
                }
                config.showModal();
            }

            config.onclick = e => e.target === config && config.close();

            folderBtn.onclick = async () => {
                folderBtn.disabled = true;
                const res = await fetch('/select-folder').catch(() => null);
                if (res?.ok) {
                    const data = await res.json();
                    if (data.status === 'success') form.elements.MARKDOWN_PATH.value = data.path;
                }
                folderBtn.disabled = false;
            };

            saveBtn.onclick = async () => {
                const data = Object.fromEntries(new FormData(form));
                saveBtn.disabled = true;
                saveBtn.textContent = '保存中...';

                const res = await fetch('/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).catch(() => null);

                if (res?.ok) {
                    const result = await res.json();
                    if (result.status === 'success') {
                        alert('✅ 配置已保存');
                        location.reload();
                    } else {
                        alert('❌ ' + (result.message || '保存失败') + (result.errors ? ':\n' + result.errors.join('\n') : ''));
                    }
                } else {
                    alert('❌ 保存失败');
                }

                saveBtn.disabled = false;
                saveBtn.textContent = '保存';
            };

            testBtn.onclick = async () => {
                const data = Object.fromEntries(new FormData(form));
                testBtn.disabled = true;
                testBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 连接中...';

                const res = await fetch('/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).catch(() => null);

                if (res?.ok) {
                    const result = await res.json();
                    alert((result.status === 'success' ? '✅ ' : '❌ ') + result.message);
                } else {
                    alert('❌ 连接失败');
                }

                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="bi bi-lightning-charge-fill"></i> 测试连接';
            };

            // 修改 loadImg 函数
            function loadImg(area) {
                const url = area.dataset.url;
                const img = area.querySelector('img');
                const placeholder = area.querySelector('.placeholder');

                if (!url || !img) return;

                // 如果已经加载过了，直接打开预览
                if (img.dataset.loaded === 'true') {
                    viewImg.src = url;
                    viewer.showModal();
                    return;
                }

                // 显示加载中状态
                placeholder.innerHTML = `
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span>加载中...</span>
                `;

                img.onload = () => {
                    img.classList.add('loaded');
                    img.dataset.loaded = 'true';
                    placeholder.style.opacity = '0'; // 隐藏占位符
                    setTimeout(() => placeholder.classList.add('hide'), 200);
                };

                img.onerror = () => {
                    placeholder.innerHTML = `
                        <i class="bi bi-exclamation-circle text-danger fs-4"></i>
                        <span class="text-danger">加载失败</span>
                    `;
                };

                img.src = url;
            }

            // 修改预览对话框关闭逻辑
            const closeViewer = () => {
                viewer.close();
                viewImg.src = ""; // 关键：关闭时清空图片地址，防止下次闪现旧图
            };

            // 绑定关闭事件
            viewer.onclick = e => (e.target === viewer || e.target === viewImg) && closeViewer();
            // 如果有专门的关闭按钮
            $('.close-btn').onclick = (e) => {
                e.stopPropagation();
                closeViewer();
            };

            // 监听 dialog 的原生关闭事件（如按 Esc 键）
            viewer.addEventListener('close', () => {
                viewImg.src = "";
            });

            // Select all
            selectAll.onchange = () => {
                $$('.form-check-input').forEach(cb => {
                    cb.checked = selectAll.checked;
                    toggleCard(cb);
                });
            };

            // Delete
            deleteBtn.onclick = async () => {
                const keys = [...$$('.form-check-input:checked')].map(cb => cb.value);

                if (!keys.length) return alert('请先选择要删除的文件');
                if (!confirm(`⚠️ 即将永久删除 ${keys.length} 张图片，确定吗？`)) return;

                deleteBtn.disabled = true;
                deleteBtn.textContent = '删除中...';

                const res = await fetch('/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keys })
                }).catch(() => null);

                if (res?.ok) {
                    const result = await res.json();
                    if (result.status === 'success') {
                        alert(`✅ 成功删除 ${result.deleted.length} 个文件`);
                        location.reload();
                    } else {
                        alert('❌ 删除失败: ' + result.message);
                    }
                } else {
                    alert('❌ 网络错误');
                }

                deleteBtn.disabled = false;
                deleteBtn.textContent = '删除选中';
            };
    </script>
  </body>
</html>
